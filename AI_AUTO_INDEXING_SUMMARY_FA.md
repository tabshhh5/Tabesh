# خلاصه پیاده‌سازی ایندکس خودکار هوش مصنوعی

## مشکل اصلی

سیستم هوش مصنوعی تابش در نسخه‌های قبلی نیازمند تنظیمات دستی برای معرفی صفحات سایت به هوش مصنوعی بود. این موضوع باعث می‌شد:
- مدیر باید تک‌به‌تک صفحات را به صورت دستی وارد کند
- هوش مصنوعی نمی‌توانست صفحات جدید را به صورت خودکار شناسایی کند
- عدم همگام‌سازی اطلاعات با محتوای واقعی سایت
- افزایش احتمال خطا در تنظیمات دستی

## راه‌حل پیاده‌سازی شده

### 1. کشف خودکار محتوا

سیستم اکنون به صورت خودکار تمام محتوای وردپرس را کشف و ایندکس می‌کند:

#### صفحات کشف شده
- ✅ **همه صفحات منتشر شده**: با استفاده از `get_pages()`
- ✅ **همه نوشته‌های منتشر شده**: با استفاده از `get_posts()`
- ✅ **انواع نوشته سفارشی**: تمام انواع نوشته عمومی

#### اطلاعات استخراج شده
برای هر صفحه:
- عنوان صفحه
- آدرس URL
- خلاصه محتوا (۵۰۰ کاراکتر اول)
- کلمات کلیدی (۲۰ کلمه برتر)
- نوع صفحه (تشخیص خودکار)

### 2. تشخیص هوشمند نوع صفحه

سیستم با استفاده از الگوریتم‌های هوشمند، نوع هر صفحه را تشخیص می‌دهد:

#### معیارهای تشخیص
1. **بررسی نامک صفحه**: مثل `order-form`، `cart`، `contact`
2. **تحلیل عنوان**: کلمات کلیدی فارسی و انگلیسی
3. **تحلیل محتوا**: بررسی ۱۰۰۰ کاراکتر اول
4. **نوع نوشته**: page، post، یا سفارشی

#### انواع صفحات پشتیبانی شده
- `order-form` - فرم‌های ثبت سفارش
- `cart` - سبد خرید
- `checkout` - صفحه پرداخت
- `account` - حساب کاربری
- `about` - درباره ما
- `contact` - تماس با ما
- `portfolio` - نمونه کارها
- `page` - صفحات عمومی
- `blog-post` - مقالات وبلاگ
- `product` - محصولات ووکامرس

### 3. زمان‌بندی خودکار

#### Cron Job روزانه
- **نام**: `tabesh_ai_index_site_pages`
- **تناوب**: روزانه
- **عملکرد**: ایندکس کردن تمام محتوای وردپرس
- **لاگ**: نتایج در `wp-content/debug.log` ثبت می‌شود

#### نحوه فعال‌سازی
Cron Job به صورت خودکار در زمان فعال‌سازی افزونه ثبت می‌شود و در زمان غیرفعال‌سازی حذف می‌گردد.

### 4. ایندکس دستی

مدیران می‌توانند در هر زمان به صورت دستی ایندکس را به‌روزرسانی کنند:

#### مسیر دسترسی
تنظیمات → تابش → تنظیمات هوش مصنوعی → ایندکس خودکار صفحات

#### قابلیت‌ها
- ✅ دکمه "ایندکس کردن همه صفحات اکنون"
- ✅ نمایش تعداد صفحات ایندکس شده
- ✅ نمایش لیست کامل صفحات با جزئیات
- ✅ نتایج لحظه‌ای با AJAX

### 5. بهبود متن هوش مصنوعی

هوش مصنوعی اکنون در هر مکالمه لیست کامل صفحات را دریافت می‌کند:

#### فرمت ارائه
```
صفحات موجود در سایت:

** فرم سفارش:
- ثبت سفارش چاپ: http://example.com/order-form/

** درباره ما:
- درباره چاپکو: http://example.com/about/

** تماس با ما:
- تماس با ما: http://example.com/contact/

** مقالات:
- نحوه انتخاب کاغذ مناسب: http://example.com/paper-guide/
- راهنمای صحافی: http://example.com/binding-guide/
```

#### نحوه استفاده توسط AI
هوش مصنوعی می‌تواند:
- صفحات مرتبط را به کاربر پیشنهاد دهد
- کاربر را به صفحه مناسب هدایت کند
- به سوالاتی مثل "کدام صفحات دارید؟" پاسخ دهد

### 6. حذف تنظیمات دستی

تنظیمات زیر از بخش هوش مصنوعی حذف شده‌اند:

#### تنظیمات حذف شده
- ❌ مسیرهای پیشنهادی (خریدار، نویسنده، ناشر، چاپخانه)
- ❌ مسیرهای هدایت هوشمند (فرم سفارش، قیمت‌ها، تماس، راهنما)
- ❌ تنظیم دستی آدرس صفحات

#### تنظیمات جایگزین
- ✅ ایندکس خودکار همه صفحات
- ✅ تشخیص خودکار نوع صفحه
- ✅ نمایش لیست صفحات ایندکس شده
- ✅ دکمه ایندکس دستی

## تغییرات فایل‌ها

### فایل‌های اصلاح شده

#### 1. `includes/ai/class-tabesh-ai-site-indexer.php`
**متدهای جدید:**
- `index_wordpress_content()` - ایندکس کردن محتوای وردپرس
- `index_wordpress_post()` - ایندکس کردن یک نوشته
- `detect_wordpress_page_type()` - تشخیص نوع صفحه
- `get_all_pages()` - دریافت همه صفحات ایندکس شده
- `get_pages_by_type()` - دریافت صفحات بر اساس نوع
- `get_page_list_for_ai()` - فرمت کردن لیست برای AI

**متدهای اصلاح شده:**
- `run_scheduled_indexing()` - استفاده از متد جدید

#### 2. `includes/ai/class-tabesh-ai-gemini.php`
**تغییرات:**
- بهبود `build_system_prompt()` برای شامل کردن لیست صفحات
- افزودن استفاده از `Tabesh_AI_Site_Indexer`

#### 3. `includes/ai/class-tabesh-ai.php`
**متدهای جدید:**
- `check_admin_permission()` - بررسی دسترسی مدیر
- `rest_index_site()` - نقطه پایانی REST API برای ایندکس دستی

**تغییرات:**
- افزودن endpoint جدید در `register_rest_routes()`

#### 4. `templates/admin/admin-settings.php`
**تغییرات:**
- حذف بخش "مسیرهای پیشنهادی"
- حذف بخش "مسیرهای هدایت هوشمند"
- افزودن بخش "ایندکس خودکار صفحات"
- افزودن دکمه ایندکس دستی با AJAX
- افزودن نمایش تعداد و لیست صفحات

#### 5. `includes/handlers/class-tabesh-admin.php`
**تغییرات:**
- حذف ذخیره `ai_route_buyer`, `ai_route_author`, etc.
- حذف ذخیره `ai_nav_route_*` options
- ساده‌سازی منطق ذخیره تنظیمات

## API جدید

### Endpoint ایندکس دستی

```
POST /wp-json/tabesh/v1/ai/index-site
```

**دسترسی:** فقط مدیران (`manage_options`)

**Headers:**
```
X-WP-Nonce: {wordpress_rest_nonce}
```

**پاسخ موفق:**
```json
{
  "success": true,
  "message": "ایندکس کردن تکمیل شد: 25 صفحه موفق، 0 صفحه ناموفق از 25 صفحه کل",
  "data": {
    "success": true,
    "indexed": 25,
    "failed": 0,
    "total": 25
  }
}
```

**پاسخ خطا:**
```json
{
  "code": "no_permission",
  "message": "شما دسترسی به این عملیات ندارید",
  "data": {
    "status": 403
  }
}
```

## امنیت

### بررسی‌های انجام شده

#### ورودی‌ها
- ✅ تمام URL‌ها با `esc_url_raw()` پاکسازی می‌شوند
- ✅ تمام فیلدهای متنی با `sanitize_text_field()` پاکسازی می‌شوند
- ✅ محتوای HTML با `wp_strip_all_tags()` پاک می‌شود

#### خروجی‌ها
- ✅ تمام URL‌ها با `esc_url()` escape می‌شوند
- ✅ تمام HTML با `esc_html()` escape می‌شود
- ✅ داده‌های JSON با `wp_json_encode()` کدگذاری می‌شوند

#### دسترسی‌ها
- ✅ ایندکس دستی نیازمند `manage_options` است
- ✅ تمام endpoint‌ها nonce را بررسی می‌کنند
- ✅ کوئری‌های دیتابیس از `$wpdb->prepare()` استفاده می‌کنند

#### دیتابیس
- ✅ تمام کوئری‌ها prepared statements هستند
- ✅ نام جدول از prefix وردپرس استفاده می‌کند
- ✅ ایندکس‌های مناسب برای بهینه‌سازی

## عملکرد

### بهینه‌سازی‌ها

1. **کوئری‌های کارآمد**
   - استفاده از توابع بومی وردپرس
   - ایندکس‌های دیتابیس برای ستون‌های پرجستجو
   - محدود کردن نتایج برای جلوگیری از مشکلات حافظه

2. **کش کردن**
   - متن AI یک‌بار در هر درخواست ساخته می‌شود
   - لیست صفحات در دیتابیس کش می‌شود
   - به‌روزرسانی روزانه برای جلوگیری از داده قدیمی

3. **پردازش ناهمزمان**
   - استفاده از WordPress Cron
   - ایندکس دستی از طریق AJAX
   - تاخیرهای کوچک بین عملیات برای جلوگیری از فشار سرور

## تست

### نحوه تست دستی

#### 1. تست ایندکس خودکار
```bash
# فعال کردن Cron وردپرس
wp cron event run tabesh_ai_index_site_pages
```

#### 2. تست ایندکس دستی
1. وارد تنظیمات شوید
2. روی دکمه ایندکس کلیک کنید
3. منتظر پیام موفقیت بمانید
4. لیست صفحات را بررسی کنید

#### 3. تست هوش مصنوعی
1. با AI چت کنید
2. بپرسید: "کدام صفحات دارید؟"
3. بررسی کنید که AI لیست صفحات را نمایش می‌دهد

### تست API

```bash
# تست endpoint ایندکس
curl -X POST \
  -H "X-WP-Nonce: YOUR_NONCE" \
  -H "Cookie: wordpress_logged_in_HASH=VALUE" \
  https://your-site.com/wp-json/tabesh/v1/ai/index-site
```

## مشکلات احتمالی و راه‌حل

### صفحات ایندکس نمی‌شوند

**علت‌های محتمل:**
- Cron وردپرس غیرفعال است
- صفحات در حالت Draft هستند
- خطا در دیتابیس

**راه‌حل:**
1. Cron را به صورت دستی اجرا کنید
2. وضعیت انتشار صفحات را بررسی کنید
3. لاگ خطاها را چک کنید

### AI صفحات را پیشنهاد نمی‌دهد

**علت‌های محتمل:**
- AI غیرفعال است
- صفحات ایندکس نشده‌اند
- کلید API Gemini نامعتبر است

**راه‌حل:**
1. فعال‌سازی AI در تنظیمات
2. ایندکس دستی صفحات
3. بررسی کلید API

## نتیجه‌گیری

این پیاده‌سازی:
- ✅ **خودکار است**: نیازی به تنظیم دستی نیست
- ✅ **هوشمند است**: تشخیص خودکار نوع صفحه
- ✅ **سریع است**: استفاده از توابع بهینه وردپرس
- ✅ **امن است**: تمام بررسی‌های امنیتی انجام شده
- ✅ **قابل نگهداری است**: کد تمیز و مستند
- ✅ **کاربرپسند است**: رابط ساده برای مدیران

سیستم هوش مصنوعی تابش اکنون به صورت کامل خودکار عمل می‌کند و نیازی به تنظیمات دستی ندارد.
