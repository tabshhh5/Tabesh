# گزارش پیاده‌سازی - ردیابی تغییرات مراحل چاپ و رفع باگ فایروال

## خلاصه پیاده‌سازی ✅

این PR دو مشکل عمده در سیستم مدیریت سفارشات تابش را رفع کرده و قابلیت‌های شفافیت و امنیتی را بهبود بخشیده است.

### ۱. ردیابی کامل تغییرات مراحل چاپ (Sub-status Tracking) ✅

**مشکل قبلی:**
- مکانیسم ثبت و نمایش تغییرات وضعیت برای زیرمجموعه‌های چاپ (مانند "آماده چاپ"، "در حال چاپ") وجود نداشت
- نمی‌شد فهمید که چه کسی در چه زمانی هر مرحله را تکمیل کرده است

**راه‌حل پیاده‌سازی شده:**
- ✅ تمام تغییرات مراحل چاپ در دیتابیس ثبت می‌شوند
- ✅ نام کاربر تغییردهنده (کارمند/مدیر) ذخیره می‌شود
- ✅ زمان دقیق تغییر با مُهر زمانی (Timestamp) ثبت می‌شود
- ✅ تاریخچه کامل در پنل ادمین نمایش داده می‌شود
- ✅ تاریخچه کامل در پنل کارمندان نمایش داده می‌شود

**نحوه کار:**
1. وقتی کارمند یا مدیر یک مرحله چاپ را تیک می‌زند (مثلاً "چاپ جلد")
2. سیستم به صورت خودکار یک رکورد در جدول `wp_tabesh_logs` ثبت می‌کند
3. اطلاعات ثبت شده:
   - نام کامل کاربر تغییردهنده
   - شناسه کاربری (User ID)
   - زمان دقیق تغییر (تاریخ و ساعت)
   - توضیح تغییر (مثلاً "مرحله 'چاپ جلد' تکمیل شد")
4. این اطلاعات در بخش "تاریخچه تغییرات مراحل چاپ" نمایش داده می‌شود

**محل نمایش تاریخچه:**
- در پنل ادمین: `[tabesh_admin_dashboard]` → جزئیات سفارش → تب عمومی
- در پنل کارمندان: `[tabesh_staff_panel]` → جستجوی سفارش → باز کردن سفارش

### ۲. رفع و فعال‌سازی فایروال روز رستاخیز (Doomsday Firewall) ✅

**مشکل قبلی:**
- کرون جاب‌های مربوط به فعالسازی و غیرفعالسازی حالت اضطراری کار نمی‌کردند
- سفارشات محرمانه (با تگ @WAR#) پنهان نمی‌شدند

**راه‌حل پیاده‌سازی شده:**
- ✅ فیلترینگ سفارشات در پنل ادمین فعال شد
- ✅ فیلترینگ سفارشات در پنل کارمندان فعال شد
- ✅ فعالسازی از طریق URL کار می‌کند
- ✅ فعالسازی از طریق REST API کار می‌کند

**نحوه کار:**
1. هر سفارشی که در قسمت یادداشت‌ها دارای تگ `@WAR#` باشد، به عنوان سفارش محرمانه شناخته می‌شود
2. در حالت عادی (Lockdown غیرفعال):
   - ادمین‌ها و کارمندان تمام سفارشات را می‌بینند
   - مشتری‌ها هرگز سفارشات WAR را نمی‌بینند
3. در حالت اضطراری (Lockdown فعال):
   - حتی ادمین‌ها و کارمندان نیز سفارشات WAR را نمی‌بینند
   - تمام سفارشات محرمانه کاملاً پنهان می‌شوند

**روش‌های فعال‌سازی:**

**۱. از طریق URL (مناسب برای Cron Job):**
```
# فعالسازی حالت اضطراری
https://yoursite.com/?tabesh_firewall_action=lockdown&key=YOUR_SECRET_KEY

# غیرفعالسازی حالت اضطراری
https://yoursite.com/?tabesh_firewall_action=unlock&key=YOUR_SECRET_KEY
```

**۲. از طریق REST API:**
```bash
# فعالسازی
curl -X POST "https://yoursite.com/wp-json/tabesh/v1/firewall/lockdown/activate" \
  -H "X-Firewall-Secret: YOUR_SECRET_KEY"

# غیرفعالسازی
curl -X POST "https://yoursite.com/wp-json/tabesh/v1/firewall/lockdown/deactivate" \
  -H "X-Firewall-Secret: YOUR_SECRET_KEY"
```

**۳. تنظیم Cron Job خودکار:**
```cron
# فعالسازی هر شب ساعت ۲۲:۰۰
0 22 * * * curl "https://yoursite.com/?tabesh_firewall_action=lockdown&key=YOUR_SECRET_KEY"

# غیرفعالسازی هر صبح ساعت ۸:۰۰
0 8 * * * curl "https://yoursite.com/?tabesh_firewall_action=unlock&key=YOUR_SECRET_KEY"
```

## تغییرات فایل‌ها

### فایل‌های بک‌اند (PHP)
1. `includes/handlers/class-tabesh-print-substeps.php`
   - افزوده شد: `log_substep_change()` - ثبت تغییرات
   - بهبود یافت: `update_substep_status()` - ثبت شناسه کاربر
   - افزوده شد: `get_substep_history()` - دریافت تاریخچه

2. `includes/handlers/class-tabesh-admin.php`
   - فیلترینگ فایروال در `get_orders()`
   - فیلترینگ فایروال در `rest_search_orders()`

3. `includes/handlers/class-tabesh-staff.php`
   - فیلترینگ فایروال در `search_orders()`

### فایل‌های فرانت‌اند (Template)
1. `templates/admin/partials/order-details-tabs.php`
   - نمایش بخش "تاریخچه تغییرات مراحل چاپ"
   - طراحی تایم‌لاین با آیکون‌ها

2. `templates/frontend/staff-panel.php`
   - نمایش تاریخچه در پنل کارمندان
   - طراحی یکپارچه با پنل ادمین

### فایل‌های استایل (CSS)
1. `assets/css/admin-dashboard.css`
   - استایل `.substep-history-container`
   - طراحی تایم‌لاین با آیکون‌ها

2. `assets/css/staff-panel.css`
   - استایل `.substep-history-section`
   - پشتیبانی از حالت تاریک
   - طراحی واکنش‌گرا (Responsive)

## تست و بررسی

### تست ردیابی مراحل چاپ
1. وارد پنل ادمین شوید
2. یک سفارش در وضعیت "تایید شده" یا "در حال چاپ" باز کنید
3. مراحل چاپ را تیک بزنید/برداشته کنید
4. بخش "تاریخچه تغییرات مراحل چاپ" را بررسی کنید
5. باید موارد زیر نمایش داده شود:
   - ✅ نام شما (کارمند/مدیر)
   - ✅ زمان دقیق تغییر
   - ✅ توضیح تغییر (مثلاً "مرحله 'چاپ جلد' تکمیل شد")

### تست فایروال روز رستاخیز
1. در تنظیمات فایروال، یک کلید امنیتی (حداقل ۳۲ کاراکتر) تنظیم کنید
2. یک سفارش ایجاد کرده و در یادداشت‌ها `@WAR#` بنویسید
3. مطمئن شوید سفارش در پنل‌ها قابل مشاهده است
4. با باز کردن این URL حالت اضطراری را فعال کنید:
   ```
   https://yoursite.com/?tabesh_firewall_action=lockdown&key=YOUR_SECRET_KEY
   ```
5. پنل ادمین را رفرش کنید
6. سفارش WAR باید پنهان شود ✅
7. برای غیرفعالسازی:
   ```
   https://yoursite.com/?tabesh_firewall_action=unlock&key=YOUR_SECRET_KEY
   ```
8. سفارش باید دوباره نمایش داده شود ✅

### بررسی دیتابیس
```sql
-- مشاهده تاریخچه تغییرات مراحل چاپ
SELECT * FROM wp_tabesh_logs 
WHERE action = 'substep_change' 
ORDER BY created_at DESC 
LIMIT 10;

-- بررسی وضعیت فایروال
SELECT * FROM wp_options 
WHERE option_name IN (
  'tabesh_firewall_enabled', 
  'tabesh_firewall_lockdown_mode', 
  'tabesh_firewall_secret_key'
);
```

## نکات امنیتی

### ردیابی مراحل چاپ
- ✅ تمام ورودی‌های کاربر با توابع WordPress Sanitize می‌شوند
- ✅ تمام خروجی‌ها با توابع Escape امن می‌شوند
- ✅ تمام درخواست‌های AJAX/REST با Nonce تأیید می‌شوند
- ✅ تمام کوئری‌های دیتابیس از Prepared Statements استفاده می‌کنند

### فایروال روز رستاخیز
- ✅ کلید امنیتی باید حداقل ۳۲ کاراکتر باشد
- ✅ سفارشات WAR هرگز به مشتری‌ها نمایش داده نمی‌شود
- ✅ تأیید کلید با `hash_equals()` برای جلوگیری از حملات Timing Attack
- ✅ تمام اقدامات فایروال در لاگ ثبت می‌شوند

## مستندات کامل
فایل `TEST_INSTRUCTIONS.md` شامل راهنمای جامع تست است که شامل موارد زیر می‌باشد:
- ✅ تست‌های کامل ردیابی مراحل چاپ
- ✅ تست‌های کامل فایروال
- ✅ نمونه‌های REST API
- ✅ راهنمای تنظیم Cron Job
- ✅ کوئری‌های بررسی دیتابیس
- ✅ راهنمای عیب‌یابی

## خلاصه برای مشتری

این آپدیت دو قابلیت مهم را به سیستم اضافه می‌کند:

### ۱. شفافیت کامل در مراحل چاپ
دیگر می‌توانید ببینید:
- چه کسی هر مرحله چاپ را تکمیل کرده
- دقیقاً چه زمانی تکمیل شده
- تاریخچه کامل تمام تغییرات

### ۲. امنیت بالا برای سفارشات محرمانه
- سفارشات محرمانه (با تگ @WAR#) را می‌توان به صورت خودکار پنهان کرد
- قابلیت فعالسازی/غیرفعالسازی از طریق Cron Job
- مناسب برای زمان‌های خاص (مثلاً شب‌ها یا آخر هفته‌ها)

تمام تغییرات با رعایت استانداردهای امنیتی WordPress و با حفظ سازگاری با نسخه‌های قبلی پیاده‌سازی شده‌اند.
