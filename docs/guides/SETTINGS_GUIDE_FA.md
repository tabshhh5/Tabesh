# راهنمای تنظیمات افزونه تابش (Tabesh Settings Guide)

## مشکل اصلی و راه حل

### مشکل
پس از ذخیره تنظیمات در پنل ادمین، تنظیمات پاک می‌شدند و فرم محاسبه‌گر در فرانت‌اند خطای "تنظیمات محصول تکمیل نشده است" را نمایش می‌داد.

### علت اصلی
1. **مشکل در پردازش فیلد paper_types**: این فیلد ساختار تو در تو دارد (مثلاً `تحریر=60,70,80`) که به درستی parse نمی‌شد
2. **عدم اعتبارسنجی**: مقادیر خالی بدون بررسی در دیتابیس ذخیره می‌شدند
3. **عدم لاگ خطاها**: مشکلات در ذخیره‌سازی قابل شناسایی نبودند

### راه حل پیاده‌سازی شده

#### 1. بهبود متد normalize_to_json_object
متد `normalize_to_json_object` اکنون می‌تواند مقادیر جداشده با کاما را به آرایه تبدیل کند:

```php
// قبل از اصلاح:
// ورودی: "تحریر=60,70,80"
// خروجی: {"تحریر": "60,70,80"}  ❌ اشتباه - رشته است نه آرایه

// بعد از اصلاح:
// ورودی: "تحریر=60,70,80"
// خروجی: {"تحریر": [60,70,80]}  ✅ درست - آرایه از اعداد
```

#### 2. افزودن اعتبارسنجی
اکنون قبل از ذخیره، بررسی می‌شود که مقدار خالی نباشد:

```php
// Don't save empty arrays - keep existing value instead
$decoded = json_decode($normalized_value, true);
if (empty($decoded)) {
    continue;
}
```

#### 3. افزودن لاگ خطاها
برای تشخیص مشکلات، خطاها در لاگ ثبت می‌شوند:

```php
if ($result === false) {
    error_log("Failed to save setting: $field - Error: " . $wpdb->last_error);
}
```

## نحوه استفاده صحیح از تنظیمات

### 1. تنظیمات عمومی (General Settings)

این فیلدها به صورت عدد ساده هستند:

```
حداقل تیراژ: 10
حداکثر تیراژ: 10000
گام تیراژ: 10
```

### 2. پارامترهای محصول (Product Parameters)

#### فیلدهای لیست ساده (با کاما جدا شوند):

```
قطع‌های کتاب: A5, A4, رقعی, وزیری, خشتی
انواع چاپ: سیاه و سفید, رنگی, ترکیبی
انواع صحافی: شومیز, جلد سخت, گالینگور, سیمی
انواع مجوز: دارم, انتشارات چاپکو, سفیر سلامت
گرماژ کاغذ جلد: 250, 300
انواع سلفون: براق, مات, بدون سلفون
خدمات اضافی: لب گرد, خط تا, شیرینک, سوراخ, شماره گذاری
```

#### فیلد انواع کاغذ و گرماژها (فرمت ویژه):

**فرمت:** هر خط یک نوع کاغذ با گرماژهای مجاز (با کاما جدا شوند)

```
تحریر=60,70,80
بالک=60,70,80,100
```

⚠️ **نکته مهم:** این فیلد حتماً باید به این فرمت باشد، در غیر این صورت فرم محاسبه‌گر کار نمی‌کند.

### 3. تنظیمات قیمت‌گذاری (Pricing Settings)

#### ضریب قطع کتاب (فرمت: نام=ضریب):

```
A5=1
A4=1.5
B5=1.2
رقعی=1.1
وزیری=1.3
خشتی=1.4
```

#### قیمت پایه کاغذ (فرمت: نام=قیمت):

```
glossy=250
matte=200
cream=180
تحریر=200
بالک=250
```

#### هزینه چاپ:

```
چاپ سیاه و سفید (هر صفحه): 200
چاپ رنگی (هر صفحه): 800
```

#### هزینه جلد:

```
جلد نرم (شومیز): 8000
جلد سخت: 15000
```

#### هزینه سلفون کاری (فرمت: نام=قیمت):

```
براق=2000
مات=2500
بدون سلفون=0
```

#### هزینه صحافی (فرمت: نام=قیمت):

```
شومیز=3000
جلد سخت=8000
گالینگور=6000
سیمی=2000
```

#### هزینه آپشن‌های اضافی (فرمت: نام=قیمت):

```
لب گرد=1000
خط تا=500
شیرینک=1500
سوراخ=300
شماره گذاری=800
uv_coating=3000
embossing=5000
special_packaging=2000
```

#### حاشیه سود:

```
درصد حاشیه سود: 0  (برای 0%)
درصد حاشیه سود: 10  (برای 10%)
درصد حاشیه سود: 15  (برای 15%)
```

#### تخفیفات کمی (فیچر جدید):

این قسمت به شما امکان می‌دهد تخفیف‌های خودکار بر اساس تیراژ سفارش تعریف کنید.

**فرمت:** `تیراژ=درصد تخفیف` (هر خط یک قانون تخفیف)

**مثال:**
```
100=10
50=5
25=2
```

**معنی:**
- سفارش‌های 100 جلد و بیشتر: 10% تخفیف
- سفارش‌های 50 جلد و بیشتر (اما کمتر از 100): 5% تخفیف
- سفارش‌های 25 جلد و بیشتر (اما کمتر از 50): 2% تخفیف
- کمتر از 25 جلد: بدون تخفیف

**امکانات:**
- ✓ اضافه کردن، ویرایش یا حذف تخفیف‌ها به صورت آزاد
- ✓ سیستم به صورت خودکار بالاترین تخفیف قابل اعمال را انتخاب می‌کند
- ✓ برای غیرفعال کردن تمام تخفیف‌ها، همه خطوط را پاک کنید
- ✓ می‌توانید از اعداد اعشاری استفاده کنید (مثلاً `100=7.5` برای 7.5% تخفیف)

**نکات مهم:**
- تخفیف‌ها به صورت نزولی بررسی می‌شوند (از بالاترین تیراژ شروع)
- فقط اولین تخفیف مطابق اعمال می‌شود (تخفیف‌ها جمع نمی‌شوند)

### 4. تنظیمات پیامک (SMS Settings)

این فیلدها به صورت متن ساده هستند:

```
نام کاربری ملی پیامک: username
رمز عبور ملی پیامک: password
شماره فرستنده: 1000XXXXXX
شماره موبایل مدیر: 09XXXXXXXXX
```

چک‌باکس‌ها:
- ✅ ارسال پیامک هنگام ثبت سفارش
- ✅ ارسال پیامک هنگام تغییر وضعیت

## نکات مهم

### 1. فرمت‌های مختلف ورودی

#### لیست ساده (Simple Array):
```
مورد1, مورد2, مورد3
```
یا
```
مورد1
مورد2
مورد3
```

#### لیست کلید-مقدار (Key-Value Object):
```
کلید1=مقدار1
کلید2=مقدار2
```

#### لیست تو در تو (Nested Array - فقط برای paper_types):
```
نوع1=مقدار1,مقدار2,مقدار3
نوع2=مقدار4,مقدار5
```

### 2. اعداد و اعشار

- اعداد صحیح: `1000`
- اعداد اعشاری: `1.5` یا `1.25`
- درصد به اعشار تبدیل می‌شود: `10%` → `0.10`

### 3. متن فارسی

همه فیلدها از متن فارسی پشتیبانی می‌کنند:
```
براق=2000
مات=2500
```

## رفع مشکلات رایج (Troubleshooting)

### خطا: "تنظیمات محصول تکمیل نشده است"

**علت:** فیلدهای `book_sizes` یا `paper_types` خالی هستند یا فرمت اشتباه دارند.

**راه حل:**
1. به تنظیمات بروید
2. بررسی کنید که فیلد "قطع‌های کتاب" حداقل یک مقدار دارد
3. بررسی کنید که فیلد "انواع کاغذ و گرماژها" به فرمت صحیح پر شده باشد:
   ```
   تحریر=60,70,80
   بالک=60,70,80,100
   ```
4. دکمه "ذخیره تنظیمات" را بزنید
5. صفحه را رفرش کنید و مطمئن شوید تنظیمات ذخیره شده‌اند

### تنظیمات بعد از ذخیره پاک می‌شوند

این مشکل با به‌روزرسانی اخیر برطرف شده است. اگر همچنان مشکل دارید:

1. لاگ خطای PHP را بررسی کنید (`wp-content/debug.log`)
2. مطمئن شوید که دیتابیس مجوزهای لازم را دارد
3. بررسی کنید که جدول `wp_tabesh_settings` موجود است

### گزینه‌های محاسبه‌گر به درستی نمایش داده نمی‌شوند

1. کش مرورگر را پاک کنید
2. از Inspect Element برای بررسی `tabeshData.paperTypes` استفاده کنید
3. مطمئن شوید که فایل `frontend.js` به درستی لود شده است

## تغییرات فنی (برای توسعه‌دهندگان)

### تغییرات در کد

1. **class-tabesh-admin.php:**
   - بهبود متد `normalize_to_json_object` برای پشتیبانی از پارامتر `parse_array_values`
   - افزودن اعتبارسنجی برای جلوگیری از ذخیره مقادیر خالی
   - افزودن لاگ خطا برای تمام عملیات `wpdb->replace`
   - استفاده از `wp_json_encode` به جای `json_encode`

2. **تست‌ها:**
   - تست نرمال‌سازی paper_types با مقادیر تو در تو
   - تست نرمال‌سازی pricing fields با مقادیر ساده
   - تست نگهداری فرمت JSON موجود

### جریان داده (Data Flow)

```
Admin Input → Normalize → Validate → Save to DB
                                      ↓
Frontend ← wp_localize_script ← Get from DB
```

## پشتیبانی

در صورت مواجهه با مشکل:

1. لاگ خطای PHP را بررسی کنید
2. Debug mode وردپرس را فعال کنید:
   ```php
   define('WP_DEBUG', true);
   define('WP_DEBUG_LOG', true);
   ```
3. خروجی Console مرورگر را بررسی کنید
4. از دستور زیر برای بررسی دیتابیس استفاده کنید:
   ```sql
   SELECT * FROM wp_tabesh_settings WHERE setting_key IN ('book_sizes', 'paper_types');
   ```

---

**تاریخ به‌روزرسانی:** 2025-10-28  
**نسخه:** 1.0.0

<!--
## پیشنهادات برای نسخه‌های آینده (برای توسعه‌دهندگان)

1. **رابط کاربری بهتر:** استفاده از رابط drag-and-drop برای مدیریت لیست‌ها
2. **اعتبارسنجی در زمان واقعی:** نمایش خطاها قبل از ذخیره
3. **پیش‌نمایش:** نمایش پیش‌نمایش زنده از تنظیمات
4. **Import/Export:** امکان بکاپ و بازیابی تنظیمات
5. **تنظیمات پیش‌فرض:** دکمه بازگشت به تنظیمات پیش‌فرض
-->
