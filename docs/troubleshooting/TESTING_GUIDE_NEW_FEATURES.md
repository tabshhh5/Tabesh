# راهنمای تست ویژگی‌های جدید تابش

## نسخه: 1.0.1
## تاریخ: 2025-11-07

این راهنما مراحل تست ویژگی‌های جدید اضافه شده به افزونه تابش را شرح می‌دهد.

---

## 1. تست انتقال فوری فایل به هاست دانلود

### پیش‌نیازها
- اتصال FTP پیکربندی شده و فعال باشد
- یک سفارش تستی با فایل آماده برای آپلود

### مراحل تست

#### 1.1. فعالسازی انتقال فوری

1. به **داشبورد وردپرس** بروید
2. از منوی **تابش** گزینه **تنظیمات** را انتخاب کنید
3. به تب **تنظیمات فایل** بروید
4. در بخش **تنظیمات FTP**، گزینه **"انتقال فوری فایل به هاست دانلود"** را فعال کنید
5. تنظیمات را **ذخیره** کنید

#### 1.2. آپلود و تست انتقال فوری

1. به **پنل مدیریت فایل‌های یک سفارش** بروید
2. یک فایل تستی آپلود کنید
3. فایل را **تایید** کنید
4. فوراً بررسی کنید که:
   - فایل بدون تأخیر به سرور FTP منتقل شود
   - در لاگ‌های دیباگ پیام زیر ظاهر شود:
     ```
     Tabesh: Starting immediate FTP transfer for file X
     Tabesh: Immediate FTP transfer completed for file X
     ```

#### 1.3. مقایسه با حالت عادی

1. گزینه **"انتقال فوری"** را غیرفعال کنید
2. فایل دیگری آپلود و تایید کنید
3. تأیید کنید که:
   - انتقال به صورت زمان‌بندی شده انجام می‌شود
   - پیام زمان‌بندی در لاگ ظاهر می‌شود:
     ```
     Tabesh: Scheduled FTP transfer for file X at [زمان]
     ```

### نتایج مورد انتظار

✅ در حالت فعال: انتقال بلافاصله پس از تایید انجام شود  
✅ در حالت غیرفعال: انتقال طبق تنظیمات تأخیر زمان‌بندی شود  
✅ هیچ خطایی در لاگ‌ها ثبت نشود

---

## 2. تست دکمه‌های پنل مدیریت فایل‌ها

### 2.1. تست دکمه دانلود

#### مراحل

1. به **صفحه مدیریت فایل‌های سفارش** بروید
2. روی دکمه **"دانلود"** یک فایل کلیک کنید
3. تأیید کنید که:
   - یک توکن دانلود امن ایجاد می‌شود
   - فایل به صورت خودکار دانلود می‌شود
   - هیچ خطای 403 یا 404 دریافت نمی‌شود

#### نتایج مورد انتظار

✅ فایل با موفقیت دانلود شود  
✅ لینک دانلود امن و محدود به زمان باشد  
✅ مدیران بتوانند همه فایل‌ها را دانلود کنند

### 2.2. تست دکمه نظر دادن

#### مراحل

1. روی دکمه **"نظر دادن"** یک فایل کلیک کنید
2. یک نظر تستی (مثلاً "فایل نیاز به اصلاح حاشیه دارد") وارد کنید
3. روی **"ثبت نظر"** کلیک کنید
4. تأیید کنید که:
   - پیام موفقیت نمایش داده می‌شود
   - صفحه ریفرش می‌شود
   - نظر در پایگاه داده ذخیره شده است

#### بررسی در پایگاه داده

```sql
SELECT * FROM wp_tabesh_file_comments WHERE file_id = [شناسه_فایل] ORDER BY created_at DESC;
```

#### نتایج مورد انتظار

✅ مودال نظر به درستی باز شود  
✅ نظر با موفقیت ثبت شود  
✅ نظر با اطلاعات کاربر (user_id) و زمان (created_at) ذخیره شود

### 2.3. تست دکمه رد کردن

#### مراحل

1. روی دکمه **"رد کردن"** یک فایل در حالت **pending** کلیک کنید
2. دلیل رد (مثلاً "رزولوشن پایین است") را وارد کنید
3. روی **"رد کردن فایل"** کلیک کنید
4. تأیید کنید که:
   - وضعیت فایل به **rejected** تغییر می‌کند
   - دلیل رد ذخیره می‌شود
   - تاریخ انقضا محاسبه و ثبت می‌شود
   - شمارش معکوس حذف برای کاربر نمایش داده می‌شود

#### نتایج مورد انتظار

✅ فایل به درستی رد شود  
✅ دلیل رد ذخیره و نمایش داده شود  
✅ تاریخ انقضا صحیح باشد (بر اساس تنظیمات `file_retention_days`)

---

## 3. تست دسترسی آپلود برای کاربران

### 3.1. تست با کاربر مشترک (Subscriber)

#### مراحل

1. یک کاربر تستی با نقش **Subscriber** ایجاد کنید
2. یک سفارش برای این کاربر ایجاد کنید
3. با این کاربر وارد شوید
4. به صفحه آپلود فایل سفارش بروید
5. یک فایل تستی آپلود کنید
6. تأیید کنید که:
   - آپلود با موفقیت انجام می‌شود
   - هیچ خطای دسترسی (403) دریافت نمی‌شود
   - فایل در پایگاه داده با `user_id` درست ذخیره می‌شود

### 3.2. تست با کاربر مشتری (Customer)

همان مراحل بالا را با یک کاربر **Customer** تکرار کنید.

### 3.3. تست محدودیت دسترسی به سفارشات

1. کاربر A یک سفارش دارد
2. کاربر B تلاش می‌کند فایلی برای سفارش کاربر A آپلود کند
3. تأیید کنید که:
   - خطای **"سفارش متعلق به شما نیست"** دریافت می‌شود
   - آپلود انجام نمی‌شود

#### نتایج مورد انتظار

✅ همه کاربران ثبت‌نام شده می‌توانند فایل آپلود کنند  
✅ کاربران فقط به سفارشات خود دسترسی دارند  
✅ ادمین‌ها می‌توانند برای هر سفارشی فایل آپلود کنند

---

## 4. تست رفع مشکل خواندن تنظیمات

### 4.1. بررسی تنظیمات پیش‌فرض

#### مراحل

1. افزونه را غیرفعال کنید
2. جدول `wp_tabesh_settings` را از پایگاه داده حذف کنید:
   ```sql
   DROP TABLE IF EXISTS wp_tabesh_settings;
   ```
3. افزونه را دوباره فعال کنید
4. تأیید کنید که تمام تنظیمات پیش‌فرض ایجاد شده‌اند:
   ```sql
   SELECT * FROM wp_tabesh_settings WHERE setting_key IN ('file_reupload_hours', 'ftp_immediate_transfer');
   ```

### 4.2. بررسی لاگ‌ها

1. حالت دیباگ را فعال کنید (`WP_DEBUG = true`)
2. صفحه مدیریت فایل‌ها را بارگذاری کنید
3. لاگ `wp-content/debug.log` را بررسی کنید
4. تأیید کنید که:
   - پیام **"Setting not found in database, using default: file_reupload_hours"** دیگر ظاهر نمی‌شود
   - تنظیمات از پایگاه داده خوانده می‌شوند

#### نتایج مورد انتظار

✅ تنظیم `file_reupload_hours` با مقدار پیش‌فرض 48 ایجاد شود  
✅ تنظیم `ftp_immediate_transfer` با مقدار پیش‌فرض 0 ایجاد شود  
✅ هیچ warning در لاگ ثبت نشود

---

## 5. تست یکپارچگی (Integration Tests)

### 5.1. سناریو کامل آپلود و مدیریت فایل

1. کاربر مشتری وارد می‌شود
2. یک سفارش ایجاد می‌کند
3. فایل محتوا و جلد را آپلود می‌کند
4. مدیر وارد می‌شود
5. فایل‌ها را بررسی و نظر می‌دهد
6. یکی را تایید و دیگری را رد می‌کند (با انتقال فوری فعال)
7. فایل تایید شده بلافاصله به FTP منتقل می‌شود
8. مشتری فایل رد شده را دانلود و اصلاح می‌کند
9. نسخه جدید را آپلود می‌کند

### تأییدات در هر مرحله

✅ همه مراحل بدون خطا انجام می‌شود  
✅ نوتیفیکیشن‌ها (SMS/Email) ارسال می‌شوند  
✅ لاگ‌های امنیتی ثبت می‌شوند  
✅ فایل‌های قدیمی بعد از تایید نسخه جدید حذف می‌شوند

---

## 6. تست عملکرد و امنیت

### 6.1. تست امنیتی دانلود

1. یک فایل را دانلود کنید و لینک را کپی کنید
2. از سیستم خارج شوید (logout)
3. تلاش کنید با لینک کپی شده به فایل دسترسی پیدا کنید
4. تأیید کنید که:
   - با توکن معتبر دانلود انجام می‌شود
   - توکن‌های منقضی شده کار نمی‌کنند
   - بدون توکن خطای 403 دریافت می‌شود

### 6.2. تست عملکرد انتقال FTP

با چندین فایل همزمان تست کنید:

1. 5 فایل را به صورت همزمان تایید کنید
2. تأیید کنید که:
   - همه فایل‌ها منتقل می‌شوند
   - هیچ فایلی گم نمی‌شود
   - زمان انتقال معقول است

---

## 7. مستندات تغییرات

### فایل‌های تغییر یافته

1. `tabesh.php` - افزودن تنظیمات پیش‌فرض جدید
2. `includes/class-tabesh-admin.php` - ثبت تنظیمات جدید در save_settings
3. `includes/class-tabesh-file-manager.php` - پیاده‌سازی انتقال فوری FTP
4. `templates/admin-settings.php` - افزودن UI برای تنظیمات جدید
5. `templates/file-management-admin.php` - افزودن دکمه‌های دانلود و نظر
6. `assets/js/admin.js` - پیاده‌سازی event handler برای دکمه‌ها

### تنظیمات جدید

- `ftp_immediate_transfer` (چک‌باکس): فعال/غیرفعال انتقال فوری
- `file_reupload_hours` (عدد): مهلت آپلود مجدد بر حسب ساعت

---

## 8. عیب‌یابی رایج

### مشکل: انتقال فوری کار نمی‌کند

**راه‌حل:**
- تنظیمات FTP را بررسی کنید
- با دکمه "تست اتصال FTP" اتصال را تست کنید
- لاگ‌های دیباگ را بررسی کنید

### مشکل: دکمه دانلود خطا می‌دهد

**راه‌حل:**
- `file_download_link_expiry` را بررسی کنید
- مطمئن شوید REST API فعال است
- نونس را بررسی کنید (ممکن است منقضی شده باشد)

### مشکل: نظرات ذخیره نمی‌شوند

**راه‌حل:**
- جدول `wp_tabesh_file_comments` را بررسی کنید
- دسترسی‌های پایگاه داده را چک کنید
- از درست بودن `file_id` مطمئن شوید

---

## نتیجه‌گیری

این مستند راهنمای کاملی برای تست تمام ویژگی‌های جدید افزونه تابش ارائه می‌دهد. لطفاً تمام سناریوها را تست کرده و نتایج را ثبت کنید.

### چک‌لیست تست نهایی

- [ ] انتقال فوری FTP کار می‌کند
- [ ] دکمه دانلود عملکردی است
- [ ] دکمه نظر دادن کار می‌کند
- [ ] دکمه رد کردن صحیح است
- [ ] همه کاربران می‌توانند آپلود کنند
- [ ] تنظیمات از DB خوانده می‌شوند
- [ ] هیچ خطای امنیتی وجود ندارد
- [ ] عملکرد مناسب است

---

**نسخه مستند:** 1.0  
**تاریخ:** 2025-11-07  
**توسعه‌دهنده:** GitHub Copilot  
