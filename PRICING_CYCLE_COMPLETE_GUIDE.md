# راهنمای کامل راه‌اندازی و عیب‌یابی چرخه قیمت‌گذاری ماتریسی

## مقدمه

این راهنما فرآیند کامل راه‌اندازی صحیح سیستم قیمت‌گذاری ماتریسی (V2) را توضیح می‌دهد تا از بروز مشکلات جلوگیری شود.

## ⚠️ نکات مهم

1. **ترتیب مراحل حیاتی است** - باید دقیقاً به ترتیب زیر عمل کنید
2. **منبع اصلی اطلاعات** - تنظیمات محصول (book_sizes) منبع اصلی و تنها منبع معتبر است
3. **ماتریس کامل الزامی است** - هر قطع باید هم paper costs و هم binding costs داشته باشد
4. **cache را در نظر بگیرید** - بعد از تغییرات، صفحه را reload کنید

## مرحله ۱: تعریف قطع‌های کتاب در تنظیمات محصول

**این مهم‌ترین مرحله است!**

### مسیر:
تنظیمات → محصولات → قطع کتاب

### مراحل:
1. به صفحه تنظیمات محصول بروید
2. بخش "قطع کتاب" را پیدا کنید
3. قطع‌های مورد نظر خود را اضافه کنید (مثال: A5، A4، رقعی، وزیری، خشتی)
4. روی دکمه "ذخیره" کلیک کنید
5. **اطمینان حاصل کنید** که پیام موفقیت نمایش داده شد

### نمونه قطع‌ها:
```
- A5
- A4  
- B5
- رقعی
- وزیری  
- خشتی
```

### ❌ اشتباهات رایج:
- فراموش کردن این مرحله و مستقیم رفتن به فرم ثبت قیمت
- تعریف قطع‌ها بعد از ثبت ماتریس‌های قیمت
- نادیده گرفتن پیام خطا هنگام ذخیره

## مرحله ۲: باز کردن فرم ثبت قیمت

### مسیر:
استفاده از shortcode `[tabesh_product_pricing]` در یک صفحه

### یا:
ایجاد لینک مستقیم در منوی admin:
```php
admin.php?page=tabesh-product-pricing
```

### بررسی وضعیت:
وقتی فرم باز می‌شود، باید:
1. لیست قطع‌هایی که در مرحله ۱ تعریف کردید را ببینید
2. موتور قیمت‌گذاری V2 غیرفعال باشد (اگر اولین بار است)

### ❌ اشتباه رایج:
اگر لیست قطع‌ها خالی است، یعنی مرحله ۱ را انجام نداده‌اید!

## مرحله ۳: فعال کردن موتور قیمت‌گذاری V2

### مراحل:
1. در فرم ثبت قیمت، بخش "وضعیت موتور قیمت‌گذاری" را پیدا کنید
2. گزینه "فعال کردن موتور قیمت‌گذاری نسخه ۲" را انتخاب کنید
3. روی دکمه مربوطه کلیک کنید
4. منتظر پیام تایید بمانید

### تایید فعال‌سازی:
باید پیام زیر را ببینید:
```
✓ موتور قیمت‌گذاری جدید فعال شد
```

### ❌ اشتباه رایج:
فعال نکردن موتور V2 و انتظار کار کردن فرم سفارش V2

## مرحله ۴: ثبت ماتریس قیمت برای هر قطع

**این مهم‌ترین مرحله از نظر محتوا است!**

### برای هر قطع کتاب:

#### ۴.۱ انتخاب قطع:
در dropdown "انتخاب قطع کتاب" قطع مورد نظر را انتخاب کنید

#### ۴.۲ تعریف قیمت صفحات (Page Costs) - **الزامی**:

باید حداقل یک ترکیب از موارد زیر را تعریف کنید:
- نوع کاغذ (مثال: تحریر، بالک، گلاسه)
- گرماژ کاغذ (مثال: 60، 70، 80، 100)
- نوع چاپ (سیاه و سفید، رنگی)
- قیمت هر صفحه

نمونه:
```
کاغذ تحریر - گرماژ 70 - سیاه و سفید: 400 تومان
کاغذ تحریر - گرماژ 70 - رنگی: 900 تومان
کاغذ بالک - گرماژ 80 - سیاه و سفید: 450 تومان
```

#### ۴.۳ تعریف قیمت صحافی (Binding Costs) - **الزامی**:

باید حداقل یک نوع صحافی تعریف کنید:
- نوع صحافی (مثال: شومیز، جلد سخت، گالینگور، سیمی)
- گرماژ جلد (مثال: 200، 250، 300، 350)
- قیمت صحافی

نمونه:
```
شومیز - جلد 250 گرمی: 5000 تومان
جلد سخت - جلد 300 گرمی: 12000 تومان
```

#### ۴.۴ تعریف خدمات اضافی (اختیاری):

مثال:
```
لب گرد: 1000 تومان به ازای هر جلد
شیرینک: 1500 تومان به ازای هر جلد
```

#### ۴.۵ تعریف حاشیه سود (اختیاری):

مثال: 20% (یعنی 0.20)

#### ۴.۶ ذخیره ماتریس:

روی دکمه "ذخیره تنظیمات قیمت‌گذاری" کلیک کنید

### پیام‌های موفقیت:

#### ماتریس کامل:
```
✓ تنظیمات قیمت‌گذاری با موفقیت ذخیره شد
```

#### ماتریس ناقص:
```
⚠️ ماتریس قیمت ذخیره شد، اما تا تکمیل تنظیمات در فرم سفارش نمایش داده نخواهد شد
```

اگر پیام دوم را دیدید، یعنی یکی از موارد الزامی (paper costs یا binding costs) را تعریف نکرده‌اید.

### ❌ اشتباهات رایج:
1. ذخیره ماتریس بدون تعریف page_costs
2. ذخیره ماتریس بدون تعریف binding_costs
3. وارد نکردن قیمت‌ها (فیلدهای خالی)
4. استفاده از فرمت اشتباه (حروف به جای عدد)

## مرحله ۵: تکرار برای تمام قطع‌ها

مرحله ۴ را برای **تمام** قطع‌هایی که در مرحله ۱ تعریف کردید تکرار کنید.

## مرحله ۶: بررسی نهایی

### با استفاده از تست:

فایل `test-complete-pricing-cycle.php` را باز کنید:
```
/wp-content/plugins/Tabesh/test-complete-pricing-cycle.php
```

این تست موارد زیر را بررسی می‌کند:
- ✅ جدول دیتابیس موجود است
- ✅ قطع‌ها در تنظیمات محصول تعریف شده‌اند
- ✅ موتور V2 فعال است
- ✅ ماتریس‌های قیمت کامل هستند
- ✅ هیچ ماتریس یتیمی وجود ندارد
- ✅ قطع‌ها برای فرم سفارش فعال هستند

### یا با استفاده از Health Checker:

```php
$checker = new Tabesh_Pricing_Health_Checker();
$health = $checker->run_health_check();

echo $checker->get_health_report();
```

## مرحله ۷: استفاده از فرم سفارش V2

حالا می‌توانید shortcode فرم سفارش V2 را استفاده کنید:
```
[tabesh_order_form_v2]
```

فرم باید:
1. لیست قطع‌های فعال را نمایش دهد
2. برای هر قطع، گزینه‌های مربوطه را نمایش دهد
3. قیمت را به درستی محاسبه کند
4. اجازه ثبت سفارش دهد

## عیب‌یابی مشکلات رایج

### مشکل: فرم سفارش خالی است یا پیام "هیچ قطع کتابی یافت نشد" نمایش می‌دهد

**علت‌های احتمالی:**
1. موتور V2 فعال نیست
2. هیچ قطعی در تنظیمات محصول تعریف نشده
3. ماتریس‌های قیمت ناقص هستند

**راه‌حل:**
1. به فرم ثبت قیمت بروید
2. چک کنید موتور V2 فعال است
3. چک کنید لیست قطع‌ها خالی نیست
4. برای هر قطع، مطمئن شوید هم page costs و هم binding costs تعریف شده

### مشکل: قطع خاصی در فرم سفارش نمایش داده نمی‌شود

**علت:**
ماتریس قیمت آن قطع ناقص است

**راه‌حل:**
1. به فرم ثبت قیمت بروید
2. آن قطع را انتخاب کنید
3. مطمئن شوید حداقل یک page cost و یک binding cost تعریف کرده‌اید
4. ذخیره کنید
5. صفحه فرم سفارش را reload کنید

### مشکل: تغییرات نمایش داده نمی‌شوند

**علت:**
Cache browser یا cache سرور

**راه‌حل:**
1. صفحه را Refresh کنید (Ctrl+F5 یا Cmd+Shift+R)
2. Cache browser را پاک کنید
3. در حالت incognito/private تست کنید

### مشکل: پیام "قطع ناشناخته" یا "pricing matrix not found"

**علت:**
- قطع در تنظیمات محصول نیست
- یا کلید در دیتابیس corruption دارد

**راه‌حل:**
1. به تنظیمات محصول بروید
2. مطمئن شوید قطع مورد نظر در لیست است
3. به فرم ثبت قیمت بروید
4. ماتریس قیمت را دوباره ذخیره کنید (این ماتریس‌های یتیم را پاک می‌کند)

## دیاگرام جریان صحیح

```
┌─────────────────────────────────────┐
│  ۱. تعریف book_sizes در تنظیمات   │
│     محصول                           │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│  ۲. باز کردن فرم ثبت قیمت          │
│     [tabesh_product_pricing]        │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│  ۳. فعال کردن موتور V2              │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│  ۴. ثبت ماتریس کامل برای قطع ۱    │
│     • page_costs ✓                  │
│     • binding_costs ✓               │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│  ۵. ثبت ماتریس کامل برای قطع ۲    │
│     • page_costs ✓                  │
│     • binding_costs ✓               │
└────────────┬────────────────────────┘
             │
             ▼
        (تکرار برای بقیه)
             │
             ▼
┌─────────────────────────────────────┐
│  ۶. بررسی با test یا health check  │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│  ۷. استفاده از فرم سفارش V2         │
│     [tabesh_order_form_v2]          │
│     ✓ کار می‌کند!                   │
└─────────────────────────────────────┘
```

## دیاگرام جریان معیوب (اشتباه)

```
❌ WRONG:

┌─────────────────────────────────────┐
│  X. فعال کردن موتور V2               │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│  X. ثبت ماتریس قیمت                 │
│     (بدون تعریف book_sizes قبلی)   │
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│  X. تعریف book_sizes                │
│     (حالا دیر شده!)                  │
└────────────┬────────────────────────┘
             │
             ▼
         ماتریس یتیم!
         چرخه شکسته!
         ❌
```

## چک‌لیست نهایی

قبل از استفاده در production، موارد زیر را چک کنید:

- [ ] تمام قطع‌ها در تنظیمات محصول تعریف شده‌اند
- [ ] موتور قیمت‌گذاری V2 فعال است
- [ ] برای هر قطع، ماتریس قیمت کامل (با page_costs و binding_costs) ذخیره شده
- [ ] هیچ ماتریس یتیمی وجود ندارد
- [ ] test-complete-pricing-cycle.php با موفقیت pass شده
- [ ] فرم سفارش V2 قطع‌ها را نمایش می‌دهد
- [ ] محاسبه قیمت درست کار می‌کند
- [ ] ثبت سفارش با موفقیت انجام می‌شود

## پشتیبانی و سوالات

اگر پس از انجام تمام مراحل بالا همچنان مشکلی دارید:

1. فایل `test-complete-pricing-cycle.php` را اجرا کنید
2. تمام خروجی تست را کپی کنید
3. WP_DEBUG را فعال کنید:
   ```php
   define('WP_DEBUG', true);
   define('WP_DEBUG_LOG', true);
   define('WP_DEBUG_DISPLAY', false);
   ```
4. فایل `wp-content/debug.log` را بررسی کنید
5. با اطلاعات بالا به پشتیبانی مراجعه کنید

## جمع‌بندی

کلید موفقیت در استفاده از سیستم قیمت‌گذاری ماتریسی:

1. **ترتیب صحیح**: ابتدا book_sizes، سپس موتور V2، سپس ماتریس‌ها
2. **ماتریس کامل**: هر قطع باید هم page_costs و هم binding_costs داشته باشد
3. **تست و بررسی**: قبل از استفاده، با تست یا health checker بررسی کنید
4. **صبر و دقت**: عجله نکنید، هر مرحله را به دقت انجام دهید

با رعایت این موارد، چرخه قیمت‌گذاری بدون مشکل کار خواهد کرد. ✓
