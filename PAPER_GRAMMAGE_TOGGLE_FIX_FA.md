# خلاصه رفع مشکل فعال شدن مجدد گرماژ کاغذ

## مشکل

زمانی که یک نوع کاغذ چند نوع گرماژ دارد (مثلاً تحریر با گرماژ‌های 70، 80 و 100 گرم) و مدیر یکی از آن‌ها را غیرفعال می‌کند (مثلاً 80 گرم) و ذخیره می‌کند، بعد از رفرش صفحه تعیین قیمت، گزینه غیرفعال شده دوباره فعال نمایش داده می‌شود و فیلد قیمت آن 0 تومان نشان می‌دهد.

## علت ریشه‌ای

در کد قبلی، وضعیت فعال/غیرفعال بودن نوع چاپ (تک‌رنگ یا رنگی) در سطح **نوع کاغذ** ذخیره می‌شد، نه در سطح **هر گرماژ**. این باعث می‌شد که اگر هر یک از گرماژ‌ها فعال باشد، همه گرماژ‌ها به اشتباه فعال نشان داده شوند.

### مثال:
اگر برای کاغذ "تحریر":
- گرماژ 70 را برای چاپ تک‌رنگ **فعال** کنید
- گرماژ 80 را برای چاپ تک‌رنگ **غیرفعال** کنید  
- گرماژ 100 را برای چاپ تک‌رنگ **فعال** کنید

در کد قبلی، چون چاپ تک‌رنگ برای دو گرماژ (70 و 100) فعال بود، سیستم به اشتباه گرماژ 80 را هم فعال نشان می‌داد!

## راه‌حل

ساختار داده تغییر کرد تا محدودیت‌ها در سطح **هر گرماژ** به صورت جداگانه ذخیره شوند.

### ساختار قدیمی (اشتباه):
```
محدودیت‌ها['نوع_چاپ_ممنوع']['تحریر'] = ['تک‌رنگ']
// این برای همه گرماژ‌ها اعمال می‌شود!
```

### ساختار جدید (درست):
```
محدودیت‌ها['نوع_چاپ_ممنوع']['تحریر']['70'] = []
محدودیت‌ها['نوع_چاپ_ممنوع']['تحریر']['80'] = ['تک‌رنگ', 'رنگی']
محدودیت‌ها['نوع_چاپ_ممنوع']['تحریر']['100'] = []
// هر گرماژ محدودیت مستقل خودش را دارد!
```

## تغییرات انجام شده

1. **فایل اصلی** (`class-tabesh-product-pricing.php`):
   - متد `parse_restrictions()` به‌روزرسانی شد تا محدودیت‌ها را در سطح هر گرماژ دنبال کند
   - هر گرماژ می‌تواند وضعیت فعال/غیرفعال مستقل داشته باشد

2. **تمپلیت صفحه قیمت‌گذاری** (`product-pricing.php`):
   - منطق نمایش به‌روزرسانی شد تا محدودیت‌های هر گرماژ را جداگانه بررسی کند

3. **موتور قیمت‌گذاری** (`class-tabesh-pricing-engine.php`):
   - اعتبارسنجی به‌روزرسانی شد تا محدودیت‌ها را در سطح گرماژ بررسی کند
   - پیام خطا شامل اطلاعات گرماژ شد

4. **مدیریت محدودیت‌ها** (`class-tabesh-constraint-manager.php`):
   - بررسی محدودیت‌ها برای هر گرماژ به صورت جداگانه

5. **فیلتر کردن گرماژ‌ها** (در چند فایل):
   - فقط گرماژ‌هایی نمایش داده می‌شوند که حداقل یک نوع چاپ فعال دارند

## تست‌های انجام شده

یک مجموعه تست جامع ایجاد شد که همه موارد را بررسی می‌کند:

```
==================================================
مجموعه تست محدودیت‌های هر گرماژ
==================================================

تست 1: گرماژ‌های متعدد با محدودیت‌های مختلف ✓ موفق
تست 2: مقایسه ساختار قدیم و جدید ✓ موفق
تست 3: فیلتر کردن گرماژ‌های موجود ✓ موفق
تست 4: بررسی اعتبارسنجی محدودیت‌ها ✓ موفق

نتیجه نهایی: ✓ همه تست‌ها موفق
==================================================
```

## دستورالعمل تست دستی

برای اطمینان از درست کار کردن رفع مشکل، این مراحل را در محیط وردپرس دنبال کنید:

1. به صفحه قیمت‌گذاری محصول بروید (شورت‌کد: `[tabesh_product_pricing]`)
2. یک قطع کتاب را انتخاب کنید
3. برای یک نوع کاغذ با چند گرماژ (مثلاً "تحریر" با 70، 80، 100):
   - برای گرماژ 70: هر دو نوع چاپ (تک‌رنگ و رنگی) را **فعال** کنید
   - برای گرماژ 80: هر دو نوع چاپ را **غیرفعال** کنید (این مورد حیاتی است!)
   - برای گرماژ 100: هر دو نوع چاپ را **فعال** کنید
4. روی "ذخیره" کلیک کنید
5. **صفحه را رفرش کنید** (F5)
6. بررسی کنید که:
   - گرماژ 70 با قیمت‌های وارد شده فعال نمایش داده شود ✓
   - گرماژ 80 **غیرفعال** باقی بماند (نه اینکه با قیمت 0 فعال شود) ← این همان رفع مشکل است!
   - گرماژ 100 با قیمت‌های وارد شده فعال نمایش داده شود ✓

### رفتار مورد انتظار پس از رفع مشکل

- وقتی یک گرماژ خاص را غیرفعال می‌کنید، بعد از رفرش صفحه همچنان غیرفعال باقی می‌ماند
- گرماژ‌های غیرفعال با قیمت 0 نمایش داده نمی‌شوند
- وضعیت فعال/غیرفعال هر گرماژ مستقل از سایر گرماژ‌ها است

### رفتار قبلی (اشتباه)

- غیرفعال کردن یک گرماژ باعث می‌شد که بعد از رفرش با قیمت 0 دوباره فعال شود
- اگر هر گرماژی فعال بود، همه گرماژ‌ها فعال نمایش داده می‌شدند

## تأثیر

این رفع مشکل اطمینان می‌دهد که:
- مدیران می‌توانند گرماژ‌های خاصی از یک نوع کاغذ را به صورت انتخابی فعال/غیرفعال کنند
- گرماژ‌های غیرفعال شده پس از ذخیره و رفرش همچنان غیرفعال می‌مانند
- داده‌های ماتریس قیمت به درستی در پایگاه داده ذخیره می‌شوند
- فرم سفارش فقط گرماژ‌هایی را نمایش می‌دهد که واقعاً فعال هستند

## سازگاری با نسخه‌های قبلی

این رفع مشکل ساختار داده `forbidden_print_types` را تغییر می‌دهد. ماتریس‌های قیمت موجود که از ساختار قدیمی استفاده می‌کنند، باید از طریق رابط مدیریت دوباره ذخیره شوند تا به ساختار جدید منتقل شوند. سیستم با داده‌های قدیمی همچنان کار می‌کند، اما قابلیت تفکیک هر گرماژ تا زمان ذخیره مجدد در دسترس نخواهد بود.

## فایل‌های تغییر یافته

1. `includes/handlers/class-tabesh-product-pricing.php` - رفع اصلی
2. `templates/admin/product-pricing.php` - رفع تمپلیت
3. `includes/handlers/class-tabesh-pricing-engine.php` - رفع اعتبارسنجی
4. `includes/handlers/class-tabesh-constraint-manager.php` - رفع بررسی محدودیت‌ها
5. `includes/handlers/class-tabesh-admin-order-form.php` - رفع فیلتر گرماژ‌ها
6. `tabesh.php` - رفع کد قدیمی
7. `test-per-weight-restrictions.php` - مجموعه تست جامع
8. `PAPER_GRAMMAGE_TOGGLE_FIX.md` - مستندات کامل به انگلیسی

## توسعه‌دهنده

رفع شده توسط GitHub Copilot در تاریخ 2025-12-21
