# Extra Services Restrictions - Visual Guide

## Problem Statement (Persian)
در فرم ثبت قیمت خدمات در قسمت ۳. خدمات اضافی برای هر خدمات اضافی تمام انواع صحافی را پارامتر های محصول فراخوانی کند و یک تیک برای هر نوع صحافی بگذارد تا مجاز بودن یا ممنوع بودن این خدمات اضافه را برای نوع صحافی مدیر تعیین کند.

## Before (قبل از تغییرات)

```
۳. خدمات اضافی
┌─────────────────────────────────────────────────────────────────┐
│ جدول قیمت‌گذاری خدمات اضافی:                                    │
│                                                                 │
│ ┌──────────┬────────┬──────────────┬──────────────────────┐     │
│ │ نام خدمت │ قیمت   │ نوع محاسبه   │ تعداد صفحات        │     │
│ ├──────────┼────────┼──────────────┼──────────────────────┤     │
│ │ لب گرد   │ 1000   │ به ازای جلد  │ -                   │     │
│ │ شیرینک   │ 1500   │ به ازای جلد  │ -                   │     │
│ │ خط تا    │ 500    │ به ازای جلد  │ -                   │     │
│ └──────────┴────────┴──────────────┴──────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘
```

**مشکل:** هیچ کنترلی بر روی این که کدام خدمات برای کدام نوع صحافی مجاز است وجود ندارد.

## After (بعد از تغییرات)

```
۳. خدمات اضافی
┌─────────────────────────────────────────────────────────────────┐
│ جدول قیمت‌گذاری خدمات اضافی:                                    │
│ [همان جدول قبلی]                                                │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ محدودیت‌های خدمات اضافی بر اساس نوع صحافی                       │
│                                                                 │
│ برای هر خدمت اضافی مشخص کنید که برای کدام نوع صحافی مجاز است.  │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ 🟡 لب گرد                                                 │   │
│ ├───────────────────────────────────────────────────────────┤   │
│ │  شومیز      [🟢 ON]  فعال                                │   │
│ │  جلد سخت    [🔴 OFF] غیرفعال ← مثال: غیرفعال شده          │   │
│ │  گالینگور   [🟢 ON]  فعال                                │   │
│ │  سیمی       [🟢 ON]  فعال                                │   │
│ │  منگنه      [🟢 ON]  فعال                                │   │
│ └───────────────────────────────────────────────────────────┘   │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ 🟡 شیرینک                                                 │   │
│ ├───────────────────────────────────────────────────────────┤   │
│ │  شومیز      [🟢 ON]  فعال                                │   │
│ │  جلد سخت    [🟢 ON]  فعال                                │   │
│ │  گالینگور   [🟢 ON]  فعال                                │   │
│ │  سیمی       [🟢 ON]  فعال                                │   │
│ │  منگنه      [🟢 ON]  فعال                                │   │
│ └───────────────────────────────────────────────────────────┘   │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ 🟡 خط تا                                                  │   │
│ ├───────────────────────────────────────────────────────────┤   │
│ │  شومیز      [🟢 ON]  فعال                                │   │
│ │  جلد سخت    [🟢 ON]  فعال                                │   │
│ │  گالینگور   [🟢 ON]  فعال                                │   │
│ │  سیمی       [🔴 OFF] غیرفعال ← مثال: غیرفعال شده          │   │
│ │  منگنه      [🟢 ON]  فعال                                │   │
│ └───────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

**راه‌حل:** مدیر می‌تواند برای هر خدمت اضافی، مشخص کند که برای کدام نوع‌های صحافی مجاز است.

## سناریوی استفاده

### مرحله ۱: تنظیمات توسط مدیر

```
مدیر فروشگاه تصمیم می‌گیرد:
✗ خدمت "لب گرد" برای "جلد سخت" غیرفعال شود
  (چون از نظر فنی امکان‌پذیر نیست)
  
✗ خدمت "خط تا" برای "سیمی" غیرفعال شود
  (چون در صحافی سیمی نیازی به خط تا نیست)
```

### مرحله ۲: سفارش مشتری

```
مشتری در فرم سفارش:
1. نوع صحافی: جلد سخت ✓
2. خدمات اضافی: لب گرد ✓

نتیجه: خطا! 
"خدمت اضافی "لب گرد" برای صحافی جلد سخت در قطع ... مجاز نیست"

مشتری مجبور است یا:
- نوع صحافی را تغییر دهد
- یا خدمت اضافی را حذف کند
```

### مرحله ۳: سفارش صحیح

```
مشتری در فرم سفارش:
1. نوع صحافی: شومیز ✓
2. خدمات اضافی: لب گرد ✓

نتیجه: موفق! ✅
قیمت محاسبه می‌شود و سفارش ثبت می‌شود.
```

## ساختار داده در دیتابیس

```json
{
  "book_size": "A5",
  "page_costs": { ... },
  "binding_costs": { ... },
  "extras_costs": {
    "لب گرد": {
      "price": 1000,
      "type": "per_unit",
      "step": 0
    },
    "شیرینک": {
      "price": 1500,
      "type": "per_unit",
      "step": 0
    }
  },
  "restrictions": {
    "forbidden_paper_types": [],
    "forbidden_binding_types": [],
    "forbidden_print_types": {},
    "forbidden_cover_weights": {},
    "forbidden_extras": {          ← جدید
      "جلد سخت": ["لب گرد"],        ← لب گرد برای جلد سخت ممنوع
      "سیمی": ["خط تا"]            ← خط تا برای سیمی ممنوع
    }
  }
}
```

## جریان داده (Data Flow)

```
┌──────────────┐
│  مدیر        │
│  در فرم      │
│  قیمت‌گذاری  │
└──────┬───────┘
       │
       │ Toggle OFF: لب گرد for جلد سخت
       ↓
┌──────────────────┐
│  POST Request    │
│  restrictions[   │
│    forbidden_    │
│    extras        │
│  ][جلد سخت]      │ ← لب گرد missing (غیرفعال)
│  [شیرینک]=0      │ ← شیرینک موجود (فعال)
└──────┬───────────┘
       │
       │ parse_restrictions()
       ↓
┌──────────────────┐
│  Database        │
│  {               │
│    "forbidden_   │
│     extras": {   │
│      "جلد سخت":  │
│       ["لب گرد"] │
│    }             │
│  }               │
└──────┬───────────┘
       │
       │ مشتری سفارش می‌دهد
       ↓
┌──────────────────┐
│  calculate_price │
│  ()              │
│                  │
│  if (لب گرد in   │
│      forbidden)  │
│    return error  │
└──────┬───────────┘
       │
       ↓
┌──────────────────┐
│  پیام خطا به     │
│  مشتری:          │
│  "خدمت اضافی     │
│  لب گرد برای     │
│  صحافی جلد سخت   │
│  مجاز نیست"      │
└──────────────────┘
```

## مزایای این رویکرد

1. **کنترل کامل:** مدیر کنترل کامل بر روی محدودیت‌ها دارد
2. **انعطاف‌پذیری:** برای هر ترکیب صحافی-خدمت می‌توان محدودیت تعریف کرد
3. **جلوگیری از خطا:** مشتری نمی‌تواند ترکیب غیرمجاز سفارش دهد
4. **سازگار با سیستم موجود:** از همان الگوی کد استفاده می‌کند

## فایل‌های تغییر یافته

```
includes/handlers/
├── class-tabesh-product-pricing.php  ← پردازش فرم
└── class-tabesh-pricing-engine.php   ← اعتبارسنجی

templates/admin/
└── product-pricing.php               ← رابط کاربری
```

## تست‌ها

✅ تست واحد منطق پردازش داده
✅ تست رابط کاربری (HTML mockup)
✅ تست امنیتی (CodeQL)
✅ تست استاندارد کد (PHPCS)
✅ تست RTL و Responsive

## نتیجه‌گیری

این قابلیت به مدیر اجازه می‌دهد:
- خدمات اضافی را برای انواع خاصی از صحافی محدود کند
- از سفارشات غیرقابل اجرا جلوگیری کند
- کنترل بهتری بر روی فرآیند سفارش داشته باشد

همه تغییرات به صورت ایمن، کارآمد و سازگار با کد موجود پیاده‌سازی شده‌اند.
