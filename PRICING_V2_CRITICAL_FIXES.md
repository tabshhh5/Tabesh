# رفع مشکلات حیاتی موتور قیمت‌گذاری V2

## خلاصه
این سند تغییرات انجام شده برای رفع مشکلات حیاتی موتور قیمت‌گذاری V2 را شرح می‌دهد.

## مشکلات شناسایی شده و رفع شده

### ۱. فرم‌های ثبت سفارش با V2 فعال کار نمی‌کنند ✅

**علت:**
- REST API endpoint همیشه `success: true` برمی‌گرداند حتی زمانی که محاسبه قیمت با خطا مواجه می‌شود
- وقتی ماتریس قیمت‌گذاری برای یک قطع تنظیم نشده باشد، خطا به درستی handle نمی‌شد
- نتیجه: frontend مقادیر `undefined` دریافت می‌کرد که منجر به نمایش "ناعدد" (NaN) می‌شد

**راه حل:**
1. **رفع خطا در REST endpoint** (`class-tabesh-order.php`):
   - اضافه کردن بررسی `error` در نتیجه `calculate_price()`
   - برگرداندن `success: false` زمانی که محاسبه با خطا مواجه می‌شود
   - اضافه کردن logging بهتر برای debugging

2. **مقداردهی خودکار ماتریس‌های قیمت‌گذاری** (`class-tabesh-product-pricing.php`):
   - اضافه کردن `maybe_initialize_pricing_matrices()` که به صورت خودکار ماتریس‌های پیش‌فرض را برای قطع‌های جدید ایجاد می‌کند
   - اضافه کردن `build_default_matrix()` برای ساخت ماتریس پیش‌فرض بر اساس پارامترهای محصول
   - جلوگیری از خطای "قیمت‌گذاری برای قطع تنظیم نشده است"

**فایل‌های تغییر یافته:**
- `includes/handlers/class-tabesh-order.php`
- `includes/handlers/class-tabesh-product-pricing.php`

---

### ۲. فراخوانی نادرست پارامترهای محصول در شورت‌کد قیمت‌گذاری ✅

**علت:**
- تمپلیت `product-pricing.php` از آرایه‌های hardcoded استفاده می‌کرد به جای خواندن از تنظیمات
- این باعث می‌شد پارامترهای تعریف شده توسط ادمین نادیده گرفته شوند
- شناسه‌های عجیب مثل "16823521145" به جای نام‌های صحیح نمایش داده می‌شد

**راه حل:**
1. **اضافه کردن متدهای کمکی برای خواندن پارامترهای محصول:**
   - `get_product_paper_types()`: خواندن انواع کاغذ و گرماژها از تنظیمات
   - `get_product_binding_types()`: خواندن انواع صحافی از تنظیمات  
   - `get_product_extras()`: خواندن خدمات اضافی از تنظیمات

2. **به‌روزرسانی تمپلیت برای استفاده از پارامترهای واقعی:**
   - بخش ۱ (هزینه هر صفحه): استفاده از `$product_paper_types`
   - بخش ۲ (صحافی): استفاده از `$product_binding_types`
   - بخش ۴ (خدمات اضافی): استفاده از `$product_extras`

**فایل‌های تغییر یافته:**
- `includes/handlers/class-tabesh-product-pricing.php`
- `templates/admin/product-pricing.php`

---

### ۳. UX بد در محدودیت‌ها (بخش ۵) ✅

**علت:**
- UI قبلی برای محدود کردن نوع‌های چاپ (تک‌رنگ/رنگی) گیج کننده بود
- کاربر باید به بخش جداگانه (۵. محدودیت‌ها) می‌رفت برای غیرفعال کردن نوع چاپ
- این منجر به اشتباهات و سردرگمی می‌شد

**راه حل:**
1. **اضافه کردن کلیدهای فعال/غیرفعال کنار هر فیلد قیمت:**
   - اضافه کردن toggle switch برای هر نوع چاپ (تک‌رنگ و رنگی)
   - مستقیماً کنار فیلد قیمت قرار گرفته است
   - UI بسیار واضح‌تر و کاربردی‌تر

2. **ساده‌سازی بخش ۵:**
   - حذف جدول محدودیت‌های نوع چاپ
   - حذف بخش کاغذهای ممنوع (کاملاً)
   - فقط محدودیت‌های صحافی باقی ماند

3. **به‌روزرسانی منطق ذخیره‌سازی:**
   - `parse_page_costs()`: نادیده گرفتن فیلدهای `*_enabled`
   - `parse_restrictions()`: ساخت محدودیت‌ها از toggle‌های غیرفعال

**فایل‌های تغییر یافته:**
- `includes/handlers/class-tabesh-product-pricing.php`
- `templates/admin/product-pricing.php`

---

### ۴. فیلد ورودی تعداد صفحات در خدمات اضافی ✅

**علت:**
- زمانی که نوع محاسبه "بر اساس تعداد صفحات" انتخاب می‌شد، فیلد ورودی گام (step) نمایش داده نمی‌شد
- کاربر نمی‌توانست مشخص کند هر چند صفحه محاسبه شود

**راه حل:**
1. **اضافه کردن ستون "گام (برای صفحات)" به جدول خدمات اضافی**
2. **اضافه کردن JavaScript برای نمایش/مخفی کردن فیلد گام:**
   - زمانی که "بر اساس تعداد صفحات" انتخاب شود، فیلد نمایش داده می‌شود
   - زمانی که گزینه‌های دیگر انتخاب شوند، مخفی می‌شود

**فایل‌های تغییر یافته:**
- `templates/admin/product-pricing.php`

---

## تغییرات کامل فایل‌ها

### includes/handlers/class-tabesh-order.php
```php
// Added error checking in calculate_price_rest()
if ( isset( $result['error'] ) && true === $result['error'] ) {
    return new WP_REST_Response(
        array(
            'success' => false,
            'message' => $result['message'] ?? __( 'خطا در محاسبه قیمت', 'tabesh' ),
        ),
        400
    );
}
```

### includes/handlers/class-tabesh-product-pricing.php

**متدهای جدید:**
- `get_product_paper_types()`: دریافت انواع کاغذ از تنظیمات
- `get_product_binding_types()`: دریافت انواع صحافی از تنظیمات
- `get_product_extras()`: دریافت خدمات اضافی از تنظیمات
- `maybe_initialize_pricing_matrices()`: مقداردهی خودکار ماتریس‌ها
- `build_default_matrix()`: ساخت ماتریس پیش‌فرض

**متدهای به‌روز شده:**
- `render()`: اضافه کردن فراخوانی `maybe_initialize_pricing_matrices()`
- `parse_page_costs()`: نادیده گرفتن فیلدهای `*_enabled`
- `parse_restrictions()`: ساخت محدودیت‌ها از toggle‌ها

### templates/admin/product-pricing.php

**بخش ۱ - هزینه هر صفحه:**
- استفاده از `$product_paper_types` به جای آرایه hardcoded
- اضافه کردن ستون‌های "فعال" با toggle switch
- اضافه کردن CSS برای toggle switch

**بخش ۲ - صحافی:**
- استفاده از `$product_binding_types` به جای آرایه hardcoded

**بخش ۴ - خدمات اضافی:**
- استفاده از `$product_extras` به جای آرایه hardcoded
- اضافه کردن ستون "گام (برای صفحات)"
- اضافه کردن JavaScript برای نمایش/مخفی کردن فیلد گام

**بخش ۵ - محدودیت‌ها:**
- حذف جدول محدودیت‌های نوع چاپ
- حذف بخش کاغذهای ممنوع
- فقط محدودیت‌های صحافی باقی ماند

---

## تست‌های مورد نیاز

### تست‌های دستی

#### ۱. تست محاسبه قیمت با V2
- [ ] فعال کردن موتور V2
- [ ] باز کردن صفحه تنظیمات قیمت‌گذاری
- [ ] بررسی ایجاد خودکار ماتریس‌های پیش‌فرض
- [ ] ویرایش قیمت‌ها و ذخیره
- [ ] محاسبه قیمت با فرم `[tabesh_order_form]`
- [ ] محاسبه قیمت با فرم `[tabesh_admin_order_form]`
- [ ] بررسی نمایش صحیح قیمت (بدون ناعدد یا undefined)

#### ۲. تست پارامترهای محصول
- [ ] تغییر انواع کاغذ در تنظیمات
- [ ] بررسی نمایش انواع کاغذ جدید در فرم قیمت‌گذاری
- [ ] تغییر انواع صحافی در تنظیمات
- [ ] بررسی نمایش انواع صحافی جدید در فرم قیمت‌گذاری
- [ ] تغییر خدمات اضافی در تنظیمات
- [ ] بررسی نمایش خدمات جدید در فرم قیمت‌گذاری

#### ۳. تست محدودیت‌ها با toggle
- [ ] غیرفعال کردن چاپ تک‌رنگ برای یک کاغذ خاص
- [ ] بررسی ذخیره صحیح محدودیت
- [ ] تلاش برای محاسبه قیمت با پارامتر محدود شده
- [ ] بررسی نمایش پیام خطای مناسب

#### ۴. تست خدمات اضافی مبتنی بر صفحات
- [ ] انتخاب "بر اساس تعداد صفحات" برای یک خدمت
- [ ] بررسی نمایش فیلد گام
- [ ] ورود مقدار گام و ذخیره
- [ ] محاسبه قیمت با این خدمت
- [ ] بررسی محاسبه صحیح هزینه بر اساس گام

#### ۵. تست ثبت سفارش کامل
- [ ] محاسبه قیمت با V2
- [ ] ثبت سفارش
- [ ] بررسی ذخیره صحیح اطلاعات سفارش
- [ ] بررسی ارسال پیامک (در صورت فعال بودن)

---

## یادداشت‌های مهم

### سازگاری با نسخه قبلی
- تمام تغییرات با V1 سازگار هستند
- اگر V2 غیرفعال باشد، سیستم به V1 باز می‌گردد
- سفارش‌های قبلی بدون تغییر کار می‌کنند

### امنیت
- تمام ورودی‌ها sanitize می‌شوند
- تمام خروجی‌ها escape می‌شوند
- نmonce verification برای تمام فرم‌ها
- بررسی دسترسی برای تنظیمات قیمت‌گذاری

### عملکرد
- Cache برای ماتریس‌های قیمت‌گذاری
- فقط یک بار مقداردهی خودکار انجام می‌شود
- Query‌های بهینه شده برای دیتابیس

---

## نتیجه‌گیری

تمام مشکلات گزارش شده رفع شده‌اند:
1. ✅ فرم‌های ثبت سفارش با V2 کار می‌کنند
2. ✅ پارامترهای محصول به درستی فراخوانی می‌شوند
3. ✅ UX محدودیت‌ها بهبود یافته است
4. ✅ فیلد گام برای خدمات اضافی اضافه شده است

تست‌های دستی توسط کاربر مورد نیاز است برای تایید نهایی.

---

**تاریخ:** دسامبر 2024  
**نسخه:** به‌روزرسانی شد برای Tabesh v1.0.4+
